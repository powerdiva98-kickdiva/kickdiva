[
  {
"name1":"mod1",   
"mod1":"(function(){'use strict';

// **[الإضافة الجديدة: آلية منع إعادة الحقن]**
// يتم فحص المتغير العام. إذا كان الكود محملاً بالفعل، يتم إظهار إشعار والتوقف.
if (window.KickChatTools_Loaded) {
    // وظيفة مبسطة للإشعار لضمان ظهورها حتى قبل تحميل الكود بالكامل
    const notifyIfLoaded = (msg) => {
        const c = document.getElementById('kick-toast-container') || (() => {
            const el = document.createElement('div');
            el.id = 'kick-toast-container';
            el.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:100002;pointer-events:none;width:320px;max-width:90%;';
            document.body.appendChild(el);
            return el;
        })();
        // لإظهار إشعار واحد فقط عند الفشل
        c.innerHTML = ''; 
        const T = document.createElement('div');
        T.style.cssText = `background:#d93025;color:#fff;font-family:'Roboto',sans-serif;font-weight:500;padding:14px 25px;border-radius:18px;box-shadow:0 4px 15px rgba(0,0,0,.3);font-size:16px;opacity:0;transform:translateX(120%);transition:all .4s cubic-bezier(.25,1,.5,1);margin-top:10px;position:relative;`;
        T.innerHTML = `<div>${msg}</div>`;
        c.appendChild(T);
        setTimeout(() => { T.style.opacity = '1'; T.style.transform = 'translateX(0)' }, 10);
        setTimeout(() => { T.style.opacity = '0'; T.style.transform = 'translateX(120%)'; T.addEventListener('transitionend', () => T.remove()); }, 4000);
    };
    
    const isArabic = localStorage.getItem('kickToolsLang') === 'ar';
    const message = isArabic ? 'الأداة محملة بالفعل. لن يتم إعادة تشغيلها.' : 'Tool already loaded. Will not reinitialize.';

    notifyIfLoaded(message);
    return; // **إيقاف التنفيذ**
}

// تعيين المتغير العام بعد التأكد من عدم وجوده مسبقًا
window.KickChatTools_Loaded = true;

try{
    const SCRIPT_VERSION = '63.2.PRO', 
          RAPID_MODE_THRESHOLD = 50, 
          originalFetch = window.fetch;

    const translations = {
        en: {
            failStream: 'Failed: Ensure you are in a live stream.',
            infoSuccess: 'Channel information successfully retrieved.',
            infoFail: 'Failed to retrieve channel information.',
            jutsuStopped: 'Process terminated.',
            turboOn: 'Intense Mode activated.',
            jutsuOn: 'Process activated.',
            saveCurrentScroll: 'Save Current Configuration',
            enterNamePlaceholder: 'Enter configuration name',
            saveScrollBtn: 'Save Configuration',
            scrollSavedSuccess: 'Successfully saved \'{name}\'.',
            confirmDeletion: 'Confirm Deletion',
            confirmDeleteMsg: 'Are you sure you want to delete this configuration?<br><b style=\'color:var(--m3-primary)\'>{name}</b>',
            yes: 'Yes',
            no: 'No',
            scrollLoaded: 'Loaded \'{name}\'.',
            settingsLoaded: 'Configuration loaded successfully.',
            noSavedScrolls: 'No saved configurations.',
            load: 'Load',
            delete: 'Delete',
            interactionTab: 'Interaction',
            scrollsTab: 'Saved Configurations',
            enterMessageLabel: 'Enter Message:',
            countLabel: 'Count:',
            delayLabel: 'Delay (ms):',
            infiniteSendLabel: 'Infinite Send',
            savedScrollsTitle: 'Saved Configurations',
            save: 'Save',
            close: 'Close',
            start: 'Start',
            stop: 'Stop',
            enterStreamFirst: 'Please enter a live stream first.',
            writeMessageHint: 'Click the pencil to write your message ✏️',
            languageToggle: 'العربية',
            widgetTitle: 'Control Panel',
            helpTitle: 'Tool Guide',
            helpMessageTitle: 'Message Composer',
            helpMessageDesc: 'Type your message(s) here. <b>Each new line will be sent as a separate message.</b> <br><br>The \'Count\' below determines how many times the entire sequence of lines will be repeated.',
            helpDelayTitle: 'Speed (Inter-Message Delay)',
            helpDelayDesc: 'This option controls the speed by setting the delay between each message. It is measured in <b>milliseconds (ms)</b>.<br><ul><li>For a delay of <b>1 second</b>, use <b>1000</b>.</li><li>For a delay of <b>5 seconds</b>, use <b>5000</b>.</li><li>For very <b>rapid</b> sending (twice per second), use <b>500</b>.</li></ul><b>Rule:</b> A higher number means slower sending. A lower number means faster sending.',
            helpTurboTitle: 'Intense Mode (Rapid Sending)',
            helpTurboDesc: 'For the maximum sending rate, enter a very small number (e.g., 1). This activates **Intense Mode (Rapid Batch Sending)**.<br><br><b>Note:</b> If the streamer has \'Slow Mode\' active in their chat, Intense Mode may not perform as expected.',
            learnAboutTool: 'Click here for the tool guide!'
        },
        ar: {
            failStream: 'فشل: تأكد أنك في بث مباشر.',
            infoSuccess: 'تم استرداد معلومات القناة بنجاح.',
            infoFail: 'فشل استرداد معلومات القناة.',
            jutsuStopped: 'تم إنهاء العملية.',
            turboOn: 'تم تفعيل الوضع المكثف.',
            jutsuOn: 'تم تفعيل العملية.',
            saveCurrentScroll: 'حفظ الإعداد الحالي',
            enterNamePlaceholder: 'اكتب اسم الإعداد هنا',
            saveScrollBtn: 'حفظ الإعداد',
            scrollSavedSuccess: 'تم حفظ \'{name}\' بنجاح.',
            confirmDeletion: 'تأكيد الحذف',
            confirmDeleteMsg: 'هل أنت متأكد من حذف هذا الإعداد؟<br><b style=\'color:var(--m3-primary)\'>{name}</b>',
            yes: 'نعم',
            no: 'لا',
            scrollLoaded: 'تم تحميل \'{name}\'',
            settingsLoaded: 'تم تحميل الإعدادات بنجاح.',
            noSavedScrolls: 'لا توجد إعدادات محفوظة.',
            load: 'إستدعاء', 
            delete: 'حذف',
            interactionTab: 'التفاعل',
            scrollsTab: 'الإعدادات المحفوظة',
            enterMessageLabel: 'إكتب رسالة:',
            countLabel: 'العدد:',
            delayLabel: 'السرعة (ms):',
            infiniteSendLabel: 'إرسال لا نهائي',
            savedScrollsTitle: 'الإعدادات المحفوظة',
            save: 'حفظ',
            close: 'إغلاق',
            start: 'تشغيل',
            stop: 'إيقاف',
            enterStreamFirst: 'الرجاء الدخول إلى بث مباشر أولاً!',
            writeMessageHint: 'إضغط على القلم و اكتب رسالتك ✏️',
            languageToggle: 'English',
            widgetTitle: 'لوحة التحكم',
            helpTitle: 'دليل الأداة',
            helpMessageTitle: 'مُنشئ الرسائل',
            helpMessageDesc: 'اكتب رسالتك (أو رسائلك) هنا. <b>كل سطر جديد تكتبه سيتم إرساله كرسالة منفصلة.</b><br><br>\'العدد\' في الأسفل يحدد عدد مرات تكرار إرسال مجموعة الأسطر بالكامل.',
            helpDelayTitle: 'السرعة (التأخير بين الرسائل)',
            helpDelayDesc: 'يتحكم هذا الخيار بالسرعة عبر تحديد فترة التأخير بين كل رسالة وأخرى. يتم حساب الوقت بـ <b>المللي ثانية (ms)</b>.<br><ul><li>لتأخير <b>ثانية واحدة</b>، اكتب <b>1000</b>.</li><li>لتأخير <b>5 ثوانٍ</b>، اكتب <b>5000</b>.</li><li>لإرسال <b>سريع جداً</b> (مرتين في الثانية)، اكتب <b>500</b>.</li></ul><b>القاعدة:</b> رقم كبير = إرسال أبطأ. رقم صغير = إرسال أسرع.',
            helpTurboTitle: 'الوضع المكثف (إرسال سريع)',
            helpTurboDesc: 'للحصول على أقصى سرعة ممكنة، أدخل رقمًا صغيرًا جدًا (مثل 1). هذا يفعّل **الوضع المكثف (الإرسال المجمّع السريع)**.<br><br><b>ملاحظة:</b> إذا كان صاحب البث مفعلًا \'الوضع البطيء\' في الدردشة، فقد لا يعمل الوضع المكثف كما هو متوقع.',
            learnAboutTool: 'إضغط هنا لدليل الأداة!'
        }
    };

    let currentLanguage = localStorage.getItem('kickToolsLang') || null;
    let helpBubbleInterval = null;

    const getText = (key, params = {}) => {
        let text = (translations[currentLanguage] || translations.en)[key] || key;
        for (const p in params) {
            text = text.replace(`{${p}}`, params[p]);
        }
        return text;
    };

    let chatroomInfo = {}, 
        sendingProcess = { active: false, cleanup: () => {} },
        savedScrolls = JSON.parse(localStorage.getItem('kickNarutoScrolls')) || [];

    const THEME_ASSETS = { font_url: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap' };

    async function findChatroomInfo(isSilent = true) {
        const s = window.location.pathname.split('/')[1];
        if (!s || s.includes('/')) {
            if (!isSilent && !document.getElementById('kick-jutsu-widget')) showKickNotification(getText('failStream'));
            return false;
        }
        try {
            const r = await originalFetch(`https://kick.com/api/v2/channels/${s}`),
                  d = await r.json();
            if (d?.chatroom?.id) {
                chatroomInfo = d.chatroom;
                if (!isSilent) showKickNotification(getText('infoSuccess'));
                return true;
            }
        } catch (e) {}
        if (!isSilent && !document.getElementById('kick-jutsu-widget')) showKickNotification(getText('infoFail'));
        return false;
    }

    async function sendMessage(m) {
        if (!window.bearerTokenGlobal || !chatroomInfo.id) {
            const f = await findChatroomInfo(true);
            if (!f) return;
        }
        if (!m || typeof m !== 'string' || !m.trim()) return;

        try {
            await originalFetch(`https://kick.com/api/v2/messages/send/${chatroomInfo.id}`, {
                method: 'POST',
                headers: {
                    accept: 'application/json',
                    'content-type': 'application/json',
                    Authorization: `Bearer ${window.bearerTokenGlobal}`
                },
                body: JSON.stringify({ content: m, type: 'message' })
            });
        } catch (e) {
            console.error(e);
        }
    }

    function stopCurrentProcess() {
        if (sendingProcess.active) {
            sendingProcess.active = false;
            if (typeof sendingProcess.cleanup === 'function') sendingProcess.cleanup();
            showKickNotification(getText('jutsuStopped'));
        }
    }

    async function startSendingProcess(lines, cycles, delay) {
        if (sendingProcess.active) {
            stopCurrentProcess();
            return;
        }
        const widgetButton = document.getElementById('jutsu-toggle-btn');
        if (!widgetButton) return;
        const counterEl = document.getElementById('jutsu-counter');

        sendingProcess.active = true;
        sendingProcess.cleanup = () => {
            widgetButton.textContent = getText('start');
            widgetButton.classList.remove('active');
            counterEl.style.display = 'none';
            sendingProcess.active = false;
        };

        widgetButton.textContent = getText('stop');
        widgetButton.classList.add('active');
        counterEl.style.display = 'inline';

        const isTurbo = delay < RAPID_MODE_THRESHOLD;
        if (isTurbo) showKickNotification(getText('turboOn'));
        else showKickNotification(getText('jutsuOn'));

        const totalMessagesToSend = lines.length * cycles;
        let messagesSentSoFar = 0;

        for (let i = 0; i < cycles; i++) {
            for (let j = 0; j < lines.length; j++) {
                if (!sendingProcess.active) break;

                const line = lines[j];
                counterEl.textContent = `[${messagesSentSoFar + 1}/${totalMessagesToSend === Infinity ? '∞' : totalMessagesToSend}]`;

                if (isTurbo) {
                    sendMessage(line);
                } else {
                    await sendMessage(line);
                }

                messagesSentSoFar++;

                if (delay > 0 && messagesSentSoFar < totalMessagesToSend) await new Promise(r => setTimeout(r, delay));
            }
            if (!sendingProcess.active) break;
        }

        if (sendingProcess.active) stopCurrentProcess();
    }

    function createModal(content, isInputModal = false) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(5px);z-index:100000;opacity:0;transition:opacity .3s ease;display:flex;align-items:center;justify-content:center;';
        
        const modal = document.createElement('div');
        modal.className = 'kick-ui-card';
        modal.style.cssText += `animation:scaleIn .3s ease-out;width:90%;max-width:${isInputModal ? '400px' : '500px'};padding:${isInputModal ? '30px' : '20px'};max-height:80vh;display:flex;flex-direction:column;`;
        modal.innerHTML = content;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        setTimeout(() => overlay.style.opacity = '1', 10);
        return { overlay, modal };
    }

    function showLanguageSelectionModal() {
        const content = `<h4 style='text-align:center;color:var(--m3-primary);margin:0 0 5px 0;'>Choose Your Language</h4><p style='text-align:center;margin:0 0 20px 0;'>اختر لغتك</p><div style='display:flex;flex-direction:column;gap:10px;'><button id='lang-select-en' class='kick-ui-btn'>English</button><button id='lang-select-ar' class='kick-ui-btn'>العربية</button></div>`;
        const { overlay } = createModal(content, false);

        const selectLang = lang => {
            currentLanguage = lang;
            localStorage.setItem('kickToolsLang', currentLanguage);
            updateUIText();
            renderSavedScrolls();
            overlay.remove();
            toggleSettingsPanel();
        };

        document.getElementById('lang-select-en').onclick = () => selectLang('en');
        document.getElementById('lang-select-ar').onclick = () => selectLang('ar');
    }

    function showHelpModal() {
        stopHelpBubbleAnimation();
        localStorage.setItem('kickToolHelpBubbleSeen', 'true');
        const content = `<h4 style='text-align:center;color:var(--m3-primary);margin-top:0;' data-lang-key='helpTitle'>${getText('helpTitle')}</h4><div style='flex:1;overflow-y:auto;padding-right:10px;'><div class='help-section'><h5 data-lang-key='helpMessageTitle'>${getText('helpMessageTitle')}</h5><p data-lang-key='helpMessageDesc'>${getText('helpMessageDesc')}</p></div><div class='help-section'><h5 data-lang-key='helpDelayTitle'>${getText('helpDelayTitle')}</h5><p data-lang-key='helpDelayDesc'>${getText('helpDelayDesc')}</p></div><div class='help-section'><h5 data-lang-key='helpTurboTitle'>${getText('helpTurboTitle')}</h5><p data-lang-key='helpTurboDesc'>${getText('helpTurboDesc')}</p></div></div><button id='help-close-btn' class='kick-ui-btn' style='margin-top:15px;' data-lang-key='close'>${getText('close')}</button>`;
        const { overlay } = createModal(content);
        document.getElementById('help-close-btn').onclick = () => overlay.remove();
    }

    function showSaveScrollModal() {
        const content = `<h4 style='text-align:center;color:var(--m3-primary);margin-top:0;' data-lang-key='saveCurrentScroll'>${getText('saveCurrentScroll')}</h4><input type='text' id='scroll-name-input' class='modal-input-rasengan' placeholder='${getText('enterNamePlaceholder')}'><button id='confirm-save-btn' class='kick-ui-btn' style='margin-top:15px;' data-lang-key='saveScrollBtn'>${getText('saveScrollBtn')}</button>`;
        const { overlay } = createModal(content, true);
        const nameInput = document.getElementById('scroll-name-input');
        nameInput.focus();

        const closeModal = () => { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 300); };
        
        document.getElementById('confirm-save-btn').onclick = () => {
            const n = nameInput.value;
            if (!n || !n.trim()) { nameInput.style.borderColor = 'var(--m3-danger)'; return; }
            
            const s = {
                name: n,
                messages: document.getElementById('main-message-input').value,
                count: document.getElementById('message-count-input').value,
                delay: document.getElementById('message-delay-input').value,
                infinite: document.getElementById('infinite-send-check').checked
            };

            savedScrolls.push(s);
            localStorage.setItem('kickNarutoScrolls', JSON.stringify(savedScrolls));
            
            renderSavedScrolls(); 
            
            showKickNotification(getText('scrollSavedSuccess', { name: n }));
            closeModal();
        };

        overlay.onclick = e => { if (e.target === overlay) closeModal(); };
    }

    function showConfirmDeleteModal(name) {
        return new Promise(resolve => {
            const content = `<h4 style='text-align:center;margin-top:0;' data-lang-key='confirmDeletion'>${getText('confirmDeletion')}</h4><p style='text-align:center;margin-bottom:20px;'>${getText('confirmDeleteMsg', { name: name })}</p><div style='display:flex;gap:10px;'><button id='confirm-delete-yes' class='kick-ui-btn danger' data-lang-key='yes'>${getText('yes')}</button><button id='confirm-delete-no' class='kick-ui-btn' style='background:#555;' data-lang-key='no'>${getText('no')}</button></div>`;
            const { overlay } = createModal(content);
            
            const closeModal = result => { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 300); resolve(result); };
            
            document.getElementById('confirm-delete-yes').onclick = () => closeModal(true);
            document.getElementById('confirm-delete-no').onclick = () => closeModal(false);
            overlay.onclick = e => { if (e.target === overlay) closeModal(false); };
        });
    }

    function loadScroll(i) {
        const s = savedScrolls[i];
        if (!s) return;
        
        document.getElementById('main-message-input').value = s.messages;
        document.getElementById('message-count-input').value = s.count;
        document.getElementById('message-delay-input').value = s.delay;
        document.getElementById('infinite-send-check').checked = s.infinite;

        const infiniteCheck = document.getElementById('infinite-send-check');
        if (infiniteCheck) infiniteCheck.dispatchEvent(new Event('change'));

        showKickNotification(getText('scrollLoaded', { name: s.name }));
        toggleSettingsPanel();
        setTimeout(() => showKickNotification(getText('settingsLoaded')), 200);
    }

    async function deleteScroll(i) {
        const scroll = savedScrolls[i];
        if (!scroll) return;
        
        const confirmed = await showConfirmDeleteModal(scroll.name);
        if (confirmed) {
            savedScrolls.splice(i, 1);
            localStorage.setItem('kickNarutoScrolls', JSON.stringify(savedScrolls));
            renderSavedScrolls();
        }
    }

    function renderSavedScrolls() {
        const c = document.getElementById('saved-scrolls-list');
        if (!c) return;
        
        c.innerHTML = '';
        if (savedScrolls.length === 0) {
            c.innerHTML = `<p style='color:#bbb;text-align:center;' data-lang-key='noSavedScrolls'>${getText('noSavedScrolls')}</p>`;
            return;
        }

        savedScrolls.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'saved-scroll-item';
            d.innerHTML = `<span style='font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'>${s.name}</span><div style='display:flex;gap:8px;flex-shrink:0;'><button data-load-idx='${i}' class='scroll-btn' data-lang-key='load'>${getText('load')}</button><button data-del-idx='${i}' class='scroll-btn danger' data-lang-key='delete'>${getText('delete')}</button></div>`;
            c.appendChild(d);
        });
    }

    function createSettingsPanel() {
        const fontLink = document.createElement('link');
        fontLink.href = THEME_ASSETS.font_url;
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);

        const uiStyles = `:root{--m3-primary:#53FC18;--m3-primary-dark:#32a810;--m3-danger:#d93025;--m3-danger-dark:#a50e0e;--m3-surface-1:rgba(35,36,40,0.95);--m3-surface-2:rgba(20,20,25,0.6);--m3-text-primary:#e8eaed;--m3-text-secondary:#bdc1c6;}@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}@keyframes toast-loader-anim{from{width:100%}to{width:0%}}.kick-toast-loader{position:absolute;bottom:0;left:0;height:4px;background:rgba(0,0,0,0.3);animation:toast-loader-anim 2.8s linear forwards;}.kick-ui-panel{position:fixed;top:50%;left:50%;background:var(--m3-surface-1);backdrop-filter:blur(14px);border-radius:28px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:9999;color:var(--m3-text-primary);font-family:'Roboto',sans-serif;width:90vw;max-width:380px;display:none;flex-direction:column;opacity:0;transform:translate(-50%,-50%) scale(.95);transition:opacity .3s ease,transform .3s ease;overflow:hidden}.kick-ui-panel *{box-sizing:border-box}.kick-ui-body{overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px}.kick-ui-card{background:var(--m3-surface-2);border-radius:18px;padding:16px;display:flex;flex-direction:column;gap:12px}.kick-ui-card label{margin-bottom:6px;display:block;font-weight:500;color:var(--m3-text-secondary);font-size:14px;}.kick-ui-panel input[type=number],.kick-ui-panel input[type=text],.kick-ui-panel textarea{color:var(--m3-text-primary)!important;background:rgba(0,0,0,.3);border:1px solid #5f6368;border-radius:12px;padding:12px;width:100%;transition:all .2s ease;font-family:'Roboto',sans-serif;font-size:16px;}.kick-ui-panel input:focus,.kick-ui-panel textarea:focus{border-color:var(--m3-primary);box-shadow:0 0 0 3px rgba(83,252,24,.2);outline:0}.kick-ui-btn{all:unset;position:relative;overflow:hidden;box-sizing:border-box;width:100%;text-align:center;padding:14px;border-radius:18px;background:var(--m3-primary);color:#000;font-size:16px;font-weight:700;cursor:pointer;transition:all .15s ease}.kick-ui-btn:active{background:var(--m3-primary-dark);transform:scale(0.98)}.kick-ui-footer{padding:12px 16px;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:space-between;font-size:14px;color:#888;flex-shrink:0;border-top:1px solid #3c4043}.footer-btn{all:unset;padding:8px 16px;background:rgba(255,255,255,.05);color:var(--m3-text-secondary);border:1px solid #5f6368;border-radius:16px;cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s ease}.footer-btn:hover{background:rgba(255,255,255,0.1);color:var(--m3-text-primary);}.saved-scroll-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,0.2);padding:12px;border-radius:12px;border:1px solid #3c4043}.scroll-btn{all:unset;padding:8px 12px;font-size:14px;background:rgba(255,255,255,0.08);border:1px solid #5f6368;border-radius:10px;cursor:pointer;font-weight:500;}.scroll-btn.danger{background:rgba(217,48,37,0.3);color:#f28b82;}.scroll-btn.danger:hover{background:rgba(217,48,37,0.5)}.kick-ui-btn.danger{background:var(--m3-danger);color:#fff;}.kick-ui-btn.danger:active{background:var(--m3-danger-dark);}.modal-input-rasengan{background:#1a1a1a !important;border:2px solid var(--m3-primary)!important;color:white !important;border-radius:18px;padding:20px!important;font-size:20px!important;text-align:center;font-weight:500;box-shadow:0 0 20px rgba(83,252,24,0.3);}.tab-nav{position:relative;display:flex;padding:0 10px;align-items:center;border-bottom:1px solid #3c4043;}.tab-buttons{flex-grow:1;display:flex;}.tab-btn{all:unset;box-sizing:border-box;flex:1;text-align:center;padding:12px;font-weight:500;cursor:pointer;color:var(--m3-text-secondary);transition:color .2s ease,border-color .2s ease;border-bottom:3px solid transparent;}.tab-btn.active{color:var(--m3-primary);border-bottom-color:var(--m3-primary);}.tab-content{display:none;padding-top:10px}.tab-content.active{display:block;}#help-btn{all:unset;cursor:pointer;font-size:20px;color:var(--m3-text-secondary);padding:8px;border-radius:50%;transition:all .2s ease;text-align:center}#help-btn:hover{color:var(--m3-primary);background:rgba(255,255,255,.05);}.help-section h5{margin:15px 0 8px 0;color:var(--m3-primary);border-bottom:1px solid #3c4043;padding-bottom:8px;font-size:16px;}.help-section p{margin:0 0 15px 0;font-size:15px;line-height:1.6;color:var(--m3-text-secondary);}.help-section ul{padding-left:20px;margin-top:5px;}.help-section li{margin-bottom:8px;}.help-bubble{position:absolute;top:50px;right:10px;background:var(--m3-primary);color:#000;padding:8px 12px;border-radius:10px;font-size:14px;font-weight:500;z-index:10;animation:scaleIn .3s;cursor:pointer;}.help-bubble::after{content:'';position:absolute;bottom:100%;right:15px;border-width:6px;border-style:solid;border-color:transparent transparent var(--m3-primary) transparent;}`;
        
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.innerText = uiStyles;
        document.head.appendChild(styleSheet);

        const ui = document.createElement('div');
        ui.id = 'kick-tools-ui';
        ui.className = 'kick-ui-panel';
        ui.innerHTML = `<div class='tab-nav'><div class='tab-buttons'><button class='tab-btn active' data-tab='interaction' data-lang-key='interactionTab'></button><button class='tab-btn' data-tab='scrolls' data-lang-key='scrollsTab'></button></div><button id='help-btn'>?</button></div><div class='kick-ui-body'><div id='tab-interaction' class='tab-content active'><div class='kick-ui-card'><div><label for='main-message-input' data-lang-key='enterMessageLabel'></label><textarea id='main-message-input' rows='2'></textarea></div><div style='display:flex;gap:15px'><div id='message-count-container' style='flex:1;transition:opacity 0.3s, max-width 0.3s, margin 0.3s, padding 0.3s; overflow:hidden; max-width: 50%;'><label data-lang-key='countLabel'></label><input id='message-count-input' type='number' value='100'></div><div style='flex:1'><label data-lang-key='delayLabel'></label><input id='message-delay-input' type='number' value='1000'></div></div><div style='display:flex;align-items:center;gap:10px'><input type='checkbox' id='infinite-send-check' style='width:20px;height:20px;accent-color:var(--m3-primary)'><label for='infinite-send-check' style='margin:0' data-lang-key='infiniteSendLabel'></label></div></div></div><div id='tab-scrolls' class='tab-content'><div class='kick-ui-card'><div style='display:flex;justify-content:space-between;align-items:center;'><h4 style='margin:0' data-lang-key='savedScrollsTitle'></h4><button id='save-scroll-btn' class='kick-ui-btn' style='width:auto;padding: 6px 12px;font-size:14px;background:rgba(255,255,255,0.08);border:1px solid #5f6368;color:#fff;' data-lang-key='save'></button></div><div id='saved-scrolls-list' style='margin-top:10px;display:flex;flex-direction:column;gap:10px;max-height:150px;overflow-y:auto;'></div></div></div></div><div class='kick-ui-footer'><button id='lang-switch-btn' class='footer-btn' data-lang-key='languageToggle'></button><button id='panel-close-btn' class='footer-btn' data-lang-key='close'></button></div>`;
        
        document.body.appendChild(ui);
        setupEventListeners(ui);
        if (currentLanguage) updateUIText();
        
        renderSavedScrolls(); 
    }

    function updateUIText() {
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.dataset.langKey;
            if (key) el.innerHTML = getText(key);
        });
        const nameInput = document.getElementById('scroll-name-input');
        if (nameInput) nameInput.placeholder = getText('enterNamePlaceholder');
    }

    function setupEventListeners(ui) {
        ui.querySelector('.tab-buttons').addEventListener('click', e => {
            if (!e.target.matches('.tab-btn')) return;
            const targetTab = e.target.dataset.tab;
            ui.querySelector('.tab-btn.active').classList.remove('active');
            e.target.classList.add('active');
            ui.querySelector('.tab-content.active').classList.remove('active');
            ui.querySelector(`#tab-${targetTab}`).classList.add('active');
        });

        document.getElementById('panel-close-btn')?.addEventListener('click', toggleSettingsPanel);
        document.getElementById('save-scroll-btn')?.addEventListener('click', showSaveScrollModal);
        document.getElementById('help-btn')?.addEventListener('click', showHelpModal);
        
        document.getElementById('lang-switch-btn')?.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
            localStorage.setItem('kickToolsLang', currentLanguage);
            updateUIText();
            renderSavedScrolls();
        });

        document.getElementById('infinite-send-check')?.addEventListener('change', e => {
            const countContainer = document.getElementById('message-count-container');
            if (countContainer) {
                if (e.target.checked) {
                    countContainer.style.opacity = '0';
                    countContainer.style.maxWidth = '0';
                    countContainer.style.margin = '0';
                    countContainer.style.padding = '0';
                } else {
                    countContainer.style.opacity = '1';
                    countContainer.style.maxWidth = '50%';
                    countContainer.style.margin = '';
                    countContainer.style.padding = '';
                }
            }
        });

        document.getElementById('saved-scrolls-list')?.addEventListener('click', e => {
            const t = e.target;
            if (t.classList.contains('scroll-btn')) {
                const l = t.dataset.loadIdx;
                const d = t.dataset.delIdx;
                
                if (l) loadScroll(parseInt(l, 10));
                if (d) deleteScroll(parseInt(d, 10));
            }
        });
    }

    function createPrimaryWidget() {
        if (document.getElementById('kick-jutsu-widget')) return;
        findChatroomInfo(true);

        const w = document.createElement('div');
        w.id = 'kick-jutsu-widget';
        w.style.cssText = `position:fixed;top:80px;left:20px;z-index:10001;background:var(--m3-surface-1);backdrop-filter:blur(10px);border-radius:18px;box-shadow:0 5px 25px rgba(0,0,0,0.3);color:#fff;padding:10px 12px;display:flex;gap:8px;align-items:center;font-family:'Roboto',sans-serif;cursor:grab;animation:scaleIn .3s ease-out;`;
        
        const initialButtonText = currentLanguage ? getText('start') : '';
        w.innerHTML = `<button id='jutsu-toggle-btn' class='kick-ui-btn' style='width:auto;padding:8px 20px;font-size:16px;' data-lang-key='start'>${initialButtonText}</button><button id='jutsu-settings-btn' style='all:unset;cursor:pointer;font-size:24px;line-height:1;padding:4px;color:var(--m3-text-secondary);'>✏️</button><span id='jutsu-counter' style='font-size:14px;color:#ccc;display:none;'></span>`;

        const s = document.createElement('style');
        s.innerText = `#jutsu-toggle-btn.active{background:var(--m3-danger)!important;color:#fff!important;}#jutsu-settings-btn:hover{color:var(--m3-primary);}`;
        document.head.appendChild(s);
        document.body.appendChild(w);

        document.getElementById('jutsu-settings-btn').onclick = () => {
            if (!localStorage.getItem('kickToolsLang')) {
                showLanguageSelectionModal();
            } else {
                toggleSettingsPanel();
            }
        };

        document.getElementById('jutsu-toggle-btn').onclick = async () => {
            if (!currentLanguage) {
                showLanguageSelectionModal();
                return;
            }
            if (sendingProcess.active) {
                stopCurrentProcess();
                return;
            }

            const hasInfo = await findChatroomInfo(true);
            if (!hasInfo) {
                showKickNotification(getText('enterStreamFirst'));
                return;
            }

            const messageValue = document.getElementById('main-message-input').value;
            if (!messageValue.trim()) {
                showKickNotification(getText('writeMessageHint'));
                return;
            }

            const isInf = document.getElementById('infinite-send-check').checked;
            const cycles = isInf ? Infinity : parseInt(document.getElementById('message-count-input').value) || 100;
            const delay = parseInt(document.getElementById('message-delay-input').value) || 1000;
            const lines = messageValue.split('\n').filter(Boolean);

            startSendingProcess(lines, cycles, delay);
        };

        let d = false, x, y;
        const oS = e => {
            e.stopPropagation();
            d = true;
            w.style.cursor = 'grabbing';
            const t = e.touches ? e.touches[0] : e;
            x = t.clientX - w.getBoundingClientRect().left;
            y = t.clientY - w.getBoundingClientRect().top;
        }, oM = e => {
            if (d) {
                e.preventDefault();
                const t = e.touches ? e.touches[0] : e;
                w.style.left = `${t.clientX - x}px`;
                w.style.top = `${t.clientY - y}px`;
            }
        }, oE = () => {
            d = false;
            w.style.cursor = 'grab';
        };

        w.addEventListener('mousedown', oS);
        w.addEventListener('touchstart', oS, { passive: false });
        document.addEventListener('mousemove', oM);
        document.addEventListener('touchmove', oM, { passive: false });
        document.addEventListener('mouseup', oE);
        document.addEventListener('touchend', oE);
    }

    function stopHelpBubbleAnimation() {
        if (helpBubbleInterval) {
            clearInterval(helpBubbleInterval);
            helpBubbleInterval = null;
        }
        const bubble = document.querySelector('.help-bubble');
        if (bubble) bubble.remove();
    }

    function startHelpBubbleAnimation(ui) {
        if (localStorage.getItem('kickToolHelpBubbleSeen')) return;
        stopHelpBubbleAnimation();

        const nav = ui.querySelector('.tab-nav');

        const createAndShowBubble = () => {
            if (document.querySelector('.help-bubble')) return;
            const bubble = document.createElement('div');
            bubble.className = 'help-bubble';
            bubble.innerHTML = getText('learnAboutTool');
            nav.appendChild(bubble);
            
            bubble.onclick = () => {
                stopHelpBubbleAnimation();
                localStorage.setItem('kickToolHelpBubbleSeen', 'true');
                showHelpModal();
            };
            
            setTimeout(() => { if (bubble) bubble.remove() }, 5000);
        };

        createAndShowBubble();
        helpBubbleInterval = setInterval(createAndShowBubble, 10000);
    }

    function toggleSettingsPanel() {
        const ui = document.getElementById('kick-tools-ui');
        const widget = document.getElementById('kick-jutsu-widget');
        if (!ui || !widget) return;

        const isVisible = ui.style.display === 'flex';
        
        if (isVisible) {
            ui.style.opacity = '0';
            ui.style.transform = 'translate(-50%,-50%) scale(0.95)';
            widget.style.zIndex = '10001';
            stopHelpBubbleAnimation();
            setTimeout(() => { ui.style.display = 'none' }, 300);
        } else {
            ui.style.display = 'flex';
            widget.style.zIndex = '9998';
            setTimeout(() => {
                ui.style.opacity = '1';
                ui.style.transform = 'translate(-50%,-50%) scale(1)';
                if (currentLanguage) startHelpBubbleAnimation(ui);
            }, 10);
        }
    }

    function showKickNotification(t) {
        let c = document.getElementById('kick-toast-container');
        if (!c) {
            c = document.createElement('div');
            c.id = 'kick-toast-container';
            c.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:100002;pointer-events:none;width:320px;max-width:90%;';
            document.body.appendChild(c);
        }

        // إزالة جميع الإشعارات الموجودة لضمان إشعار واحد
        c.innerHTML = ''; 
        
        const T = document.createElement('div');
        T.style.cssText = `background:#282a2e;color:var(--m3-text-primary);font-family:'Roboto',sans-serif;font-weight:500;padding:14px 25px;border-radius:18px;box-shadow:0 4px 15px rgba(0,0,0,.3);font-size:16px;opacity:0;transform:translateX(120%);transition:all .4s cubic-bezier(.25,1,.5,1);margin-top:10px;position:relative;overflow:hidden;border: 1px solid #3c4043;`;
        T.innerHTML = `<div>${t}</div><div class='kick-toast-loader' style='background: var(--m3-primary)'></div>`;

        c.appendChild(T);
        setTimeout(() => { T.style.opacity = '1'; T.style.transform = 'translateX(0)' }, 10);
        setTimeout(() => {
            T.style.opacity = '0';
            T.style.transform = 'translateX(120%)';
            T.addEventListener('transitionend', () => T.remove());
        }, 3000);
    }

    // Initialization logic
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            createSettingsPanel();
            createPrimaryWidget();
        });
    } else {
        createSettingsPanel();
        createPrimaryWidget();
    }

    // Bearer Token Interception
    window.fetch = async function(...a) {
        const r = await originalFetch.apply(this, a);
        try {
            const t = a[1]?.headers?.Authorization?.substring(7);
            if (t && t !== window.bearerTokenGlobal) window.bearerTokenGlobal = t;
        } catch (e) {}
        return r;
    };

}catch(error){
    console.error('A critical error occurred in KickChatTools:', error);
}})();",
"status":"open",
"status_lock_msg_ar":"عذرا السيرفر مغلق حاليآ",
"status_lock_msg_en":"Sorry the server is currently closed"
  }
]
